#!/bin/bash
# Heroku buildpack to compile and install libheif 1.18.0+ from source
# This is needed because Ubuntu repositories only provide libheif 1.17.6

set -e

# Ensure BUILD_DIR is set (Heroku sets this, but let's be safe)
BUILD_DIR="${BUILD_DIR:-/app}"

# Verify BUILD_DIR exists
if [ ! -d "$BUILD_DIR" ]; then
  echo "       ERROR: BUILD_DIR does not exist: $BUILD_DIR"
  exit 1
fi

# Configuration
LIBHEIF_VERSION="1.18.2"
# Install to BUILD_DIR/vendor/libheif (will be available at runtime as /app/vendor/libheif)
INSTALL_PREFIX="${BUILD_DIR}/vendor/libheif"
BUILD_DIR_TEMP=$(mktemp -d)

# Ensure INSTALL_PREFIX is absolute
if [[ ! "$INSTALL_PREFIX" = /* ]]; then
  INSTALL_PREFIX="${BUILD_DIR}/${INSTALL_PREFIX}"
fi

# Colors for output
indent() {
  sed 's/^/       /'
}

echo "-----> Installing libheif ${LIBHEIF_VERSION} from source..."
echo "       BUILD_DIR: $BUILD_DIR"
echo "       INSTALL_PREFIX: $INSTALL_PREFIX"

# Create install directory structure
echo "-----> Creating install directory..."
mkdir -p "${INSTALL_PREFIX}/lib" "${INSTALL_PREFIX}/include" "${INSTALL_PREFIX}/bin" 2>&1 | indent

# Install build dependencies
echo "-----> Installing build dependencies..."
apt-get update -qq | indent
apt-get install -y --no-install-recommends \
  build-essential \
  cmake \
  pkg-config \
  wget \
  tar \
  libde265-dev \
  libx265-dev \
  libaom-dev \
  libdav1d-dev \
  libyuv-dev \
  libjpeg-dev \
  libpng-dev \
  2>&1 | indent

# Download libheif source
echo "-----> Downloading libheif ${LIBHEIF_VERSION} source..."
cd "$BUILD_DIR_TEMP"
wget -q "https://github.com/strukturag/libheif/releases/download/v${LIBHEIF_VERSION}/libheif-${LIBHEIF_VERSION}.tar.gz" 2>&1 | indent

# Extract source
echo "-----> Extracting source..."
tar -xzf "libheif-${LIBHEIF_VERSION}.tar.gz" 2>&1 | indent
cd "libheif-${LIBHEIF_VERSION}"

# Configure and build
echo "-----> Configuring libheif..."
mkdir build && cd build
cmake .. \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INSTALL_PREFIX="${INSTALL_PREFIX}" \
  -DCMAKE_INSTALL_LIBDIR="lib" \
  -DBUILD_SHARED_LIBS=ON \
  -DWITH_DAV1D=ON \
  -DWITH_AOM=ON \
  -DWITH_X265=ON \
  -DWITH_LIBDE265=ON \
  2>&1 | indent

echo "-----> Compiling libheif (this may take a few minutes)..."
make -j$(nproc) 2>&1 | indent

echo "-----> Installing libheif..."
make install 2>&1 | indent

# Export environment variables for subsequent buildpacks
# This allows the vips buildpack to find libheif during compilation
export LD_LIBRARY_PATH="${LD_LIBRARY_PATH}:${INSTALL_PREFIX}/lib"
export PKG_CONFIG_PATH="${PKG_CONFIG_PATH}:${INSTALL_PREFIX}/lib/pkgconfig"
export LIBHEIF_DIR="${INSTALL_PREFIX}"

echo "       Exported PKG_CONFIG_PATH and LD_LIBRARY_PATH for vips buildpack"

# Set up environment variables for runtime
echo "-----> Setting up environment variables..."
mkdir -p "${BUILD_DIR}/.profile.d" 2>&1 | indent
cat > "${BUILD_DIR}/.profile.d/libheif.sh" <<'EOF'
export LD_LIBRARY_PATH="${LD_LIBRARY_PATH}:/app/vendor/libheif/lib"
export PKG_CONFIG_PATH="${PKG_CONFIG_PATH}:/app/vendor/libheif/lib/pkgconfig"
export LIBHEIF_DIR="/app/vendor/libheif"
EOF

# Update library cache (skip - we use LD_LIBRARY_PATH instead)
# Note: Cannot write to /etc/ld.so.conf.d/ on Heroku (requires root)
# LD_LIBRARY_PATH is set in .profile.d/libheif.sh and is sufficient
echo "-----> Library paths will be set via LD_LIBRARY_PATH environment variable"

# Verify installation
echo "-----> Verifying installation..."
if [ -f "${INSTALL_PREFIX}/lib/libheif.so" ]; then
  echo "       libheif installed successfully to ${INSTALL_PREFIX}"
  "${INSTALL_PREFIX}/bin/heif-info" --version 2>&1 | indent || echo "       (heif-info not available, but library installed)"
else
  echo "       ERROR: libheif library not found after installation"
  exit 1
fi

# Ensure files are included in slug
# Create marker files to ensure the directory is tracked
echo "-----> Ensuring libheif files are included in slug..."
touch "${INSTALL_PREFIX}/.heroku-keep" 2>&1 | indent || true
touch "${INSTALL_PREFIX}/lib/.heroku-keep" 2>&1 | indent || true
touch "${INSTALL_PREFIX}/include/.heroku-keep" 2>&1 | indent || true
touch "${INSTALL_PREFIX}/bin/.heroku-keep" 2>&1 | indent || true

# Verify the directory structure and file count
echo "       Verifying installation directory structure..."
if [ -d "${INSTALL_PREFIX}" ]; then
  echo "       Directory exists: ${INSTALL_PREFIX}"
  echo "       Files in lib directory:"
  ls -la "${INSTALL_PREFIX}/lib/" 2>&1 | indent || true
  echo "       Total files installed:"
  find "${INSTALL_PREFIX}" -type f | wc -l | indent || true
else
  echo "       ERROR: Installation directory not found: ${INSTALL_PREFIX}"
  exit 1
fi

# Explicitly verify critical files exist
echo "       Verifying critical files..."
CRITICAL_FILES=(
  "${INSTALL_PREFIX}/lib/libheif.so"
  "${INSTALL_PREFIX}/lib/libheif.so.1"
  "${INSTALL_PREFIX}/include/libheif/heif.h"
)

for file in "${CRITICAL_FILES[@]}"; do
  if [ -f "$file" ]; then
    echo "       ✓ Found: $file"
  else
    echo "       ✗ Missing: $file"
    # Don't fail on missing .so.1 (might be a symlink) or header
    if [[ "$file" == *"libheif.so" ]] && [[ "$file" != *".so.1" ]]; then
      echo "       ERROR: Critical file missing: $file"
      exit 1
    fi
  fi
done

# Clean up build files
echo "-----> Cleaning up..."
cd /
rm -rf "$BUILD_DIR_TEMP"

# Remove build dependencies to reduce slug size
echo "-----> Removing build dependencies..."
apt-get purge -y build-essential cmake pkg-config wget 2>&1 | indent || true
apt-get autoremove -y 2>&1 | indent || true

echo "-----> libheif ${LIBHEIF_VERSION} installation complete!"

